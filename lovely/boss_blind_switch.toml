[manifest]
version = "1.0.0"
dump_lua = true
priority = 0

# logic so i will not suffer i lot
[[patches]]
[patches.pattern]
target = '''=[SMODS _ "src/utils.lua"]'''
pattern = '''SMODS.calculate_individual_effect = function(effect, scored_card, key, amount, from_edition)'''
position = "after"
payload = '''
is_boss_add_chips_active = false
if G.GAME.blind.name == 'bl_watsau_the_flip' then
    is_boss_add_chips_active = true
end

'''
match_indent = true
overwrite = false

# smods/src/utils.lua
# modify it when blind is true

# replace +Mult into +Chips pain
[[patches]]
[patches.pattern]
target = '''=[SMODS _ "src/utils.lua"]'''
pattern = """if (key == 'mult' or key == 'h_mult' or key == 'mult_mod') and amount then
        mult = mod_mult(mult + amount)
        update_hand_text({delay = 0}, {chips = hand_chips, mult = mult})
        if not effect.remove_default_message then
            if from_edition then
                card_eval_status_text(scored_card, 'jokers', nil, percent, nil, {message = localize{type = 'variable', key = amount > 0 and 'a_mult' or 'a_mult_minus', vars = {amount}}, mult_mod = amount, colour = G.C.DARK_EDITION, edition = true})
            else
                if key ~= 'mult_mod' then
                    if effect.mult_message then
                        card_eval_status_text(scored_card or effect.card or effect.focus, 'extra', nil, percent, nil, effect.mult_message)
                    else
                        card_eval_status_text(scored_card or effect.card or effect.focus, 'mult', amount, percent)
                    end
                end
            end
        end
        return true
    end"""
position = "at"
payload = """
if (key == 'mult' or key == 'h_mult' or key == 'mult_mod') and amount then
    if is_boss_add_chips_active == true then
        hand_chips = mod_chips(hand_chips + amount)
        update_hand_text({delay = 0}, {chips = hand_chips, mult = mult})
        if not effect.remove_default_message then
            if from_edition then
                card_eval_status_text(scored_card, 'jokers', nil, percent, nil, {message = localize{type = 'variable', key = amount > 0 and 'a_chips' or 'a_chips_minus', vars = {amount}}, chip_mod = amount, colour = G.C.EDITION, edition = true})
            else
                if key ~= 'mult_mod' then
                    if effect.chip_message then
                        card_eval_status_text(scored_card or effect.card or effect.focus, 'extra', nil, percent, nil, effect.chip_message)
                    else
                        card_eval_status_text(scored_card or effect.card or effect.focus, 'chips', amount, percent, nil, effect.chip_message)
                    end
                else
                    if string.match(amount, "%+%d+ Mult") then
                        print("Match " .. amount .. "/ key : " .. key)
                        amount = string.match(amount, "%+?(%d+)")
                        card_eval_status_text(scored_card or effect.card or effect.focus, 'chips', amount, percent, nil, effect.chip_message)
                    else
                        print("No match." .. amount)
                    end
                    
                end

            end
        end

        return true
    else
        mult = mod_mult(mult + amount)
        update_hand_text({delay = 0}, {chips = hand_chips, mult = mult})
        if not effect.remove_default_message then
            if from_edition then
                card_eval_status_text(scored_card, 'jokers', nil, percent, nil, {message = localize{type = 'variable', key = amount > 0 and 'a_mult' or 'a_mult_minus', vars = {amount}}, mult_mod = amount, colour = G.C.DARK_EDITION, edition = true})
            else
                if key ~= 'mult_mod' then
                    if effect.mult_message then
                        card_eval_status_text(scored_card or effect.card or effect.focus, 'extra', nil, percent, nil, effect.mult_message)
                    else
                        card_eval_status_text(scored_card or effect.card or effect.focus, 'mult', amount, percent)
                    end
                end
            end
        end
        return true

    end
end
"""
match_indent = true
overwrite = false

# patch message thingy
[[patches]]
[patches.pattern]
target = '''=[SMODS _ "src/utils.lua"]'''
pattern = """if key == 'message' then
        card_eval_status_text(effect.message_card or effect.juice_card or scored_card or effect.card or effect.focus, 'extra', nil, percent, nil, effect)
        return true
    end"""
position = "at"
payload = """
if key == 'message'  then 
    if is_boss_add_chips_active == true then
        print("EXTRA" .. amount)
        if string.match(amount, "%+%d+ Mult") then
            amount = tonumber(string.match(amount, "%+?(%d+)"))
            card_eval_status_text(scored_card or effect.card or effect.focus, 'chips', amount, percent, nil, effect.chip_message)
            return true
        end
    else
        return SMODS.calculate_effect(amount, scored_card)
    end
end
"""
match_indent = true
overwrite = false













#
[[patches]]
[patches.pattern]
target = "functions/state_events.lua"
pattern = """if not extra.edition and (extra.mult_mod or extra.Xmult_mod)  then
            colour = G.C.MULT
        end"""
position = "at"
payload = """if is_boss_add_chips_active = true then
    if not extra.edition and (extra.mult_mod)  then
            colour = G.C.CHIPS
        end
        if not extra.edition and (extra.Xmult_mod)  then
            colour = G.C.MULT
        end
else
    if not extra.edition and (extra.mult_mod or extra.Xmult_mod)  then
            colour = G.C.MULT
        end
end
"""
match_indent = true
overwrite = false

# # 761
# [[patches]]
# [patches.pattern]
# target = "functions/state_events.lua"
# pattern = "mult = mult + (effects[ii].edition.mult_mod or 0)"
# position = "at"
# payload = """if is_boss_add_chips_active = true then
#     hand_chips = mod_chips(hand_chips + (effects[ii].edition.mult_mod or 0))
# else
#     mult = mult + (effects[ii].edition.mult_mod or 0)
# end
# """
# match_indent = true
# overwrite = false

# [[patches]]
# [patches.pattern]
# target = "functions/state_events.lua"
# pattern = "mult = mod_mult(mult + effects[ii].h_mult)"
# position = "at"
# payload = """if is_boss_add_chips_active = true then
#     hand_chips = mod_chips(hand_chips + effects[ii].h_mult)
# else
#     mult = mod_mult(mult + effects[ii].h_mult)
# end
# """
# match_indent = true

# [[patches]]
# [patches.pattern]
# target = "functions/state_events.lua"
# pattern = "mult = mod_mult(mult + edition_effects.jokers.mult_mod)"
# position = "at"
# payload = """if is_boss_add_chips_active = true then
#     hand_chips = mod_chips(hand_chips + edition_effects.jokers.mult_mod)
# else
#     mult = mod_mult(mult + edition_effects.jokers.mult_mod)
# end
# """
# match_indent = true




# [[patches]]
# [patches.pattern]
# target = "functions/state_events.lua"
# pattern = "if effects.jokers.mult_mod then mult = mod_mult(mult + effects.jokers.mult_mod);extras.mult = true end"
# position = "at"
# payload = """if is_boss_add_chips_active = true then
#     if effects.jokers.mult_mod then hand_chips = mod_chips(hand_chips + effects.jokers.mult_mod);extras.hand_chips = true end
# else
#     if effects.jokers.mult_mod then mult = mod_mult(mult + effects.jokers.mult_mod);extras.mult = true end
# end
# """
# match_indent = true

# [[patches]]
# [patches.pattern]
# target = "functions/state_events.lua"
# pattern = "if effect.mult_mod then mult = mod_mult(mult + effect.mult_mod);extras.mult = true end"
# position = "at"
# payload = """if is_boss_add_chips_active = true then
#     if effect.mult_mod then hand_chips = mod_chips(hand_chips + effect.mult_mod);extras.chips = true end
# else
#     if effect.mult_mod then mult = mod_mult(mult + effect.mult_mod);extras.mult = true end
# end
# """
# match_indent = true